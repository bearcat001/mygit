<?php
	class M_user extends CI_Model{
		private $user_table;
		private $session_table;
		
		/**
		 * 构造函数 
		 */
		function __construct(){
			parent::__construct();
			$this->user_table=$this->db->dbprefix('user');
			$this->session_table=$this->db->dbprefix('session');
			$this->load->helper(array('check','email'));
		}
		
		/**
		 * 创建数据库
		 * @return unknown
		 */
		function create_table(){
			$result= $this->db->simple_query("
					CREATE TABLE {$this->user_table} (
					  `user_id` int(10) unsigned NOT NULL AUTO_INCREMENT,
					  `email` varchar(200) NOT NULL UNIQUE,
					  `password` varchar(49) DEFAULT NULL,
					  `real_name` varchar(32) NOT NULL,
					  `display_name` varchar(32) DEFAULT NULL,
					  `create_time` int(10) unsigned NOT NULL,
					  `last_activity` int(10) unsigned NOT NULL,
					  `bluetooth_mac` varchar(12) NOT NULL,
					  PRIMARY KEY (`user_id`)
					) ENGINE=MyISAM  DEFAULT CHARSET=utf8;"
					);
			$result2=$this->db->simple_query("
					CREATE TABLE IF NOT EXISTS  {$this->session_table} (
						session_id varchar(40) DEFAULT '0' NOT NULL,
						ip_address varchar(16) DEFAULT '0' NOT NULL,
						user_agent varchar(120) NOT NULL,
						last_activity int(10) unsigned DEFAULT 0 NOT NULL,
						user_data text DEFAULT '' NOT NULL,
						PRIMARY KEY (session_id)
					);");
			return $result;
		}
		
		/**
		 * 添加一个用户
		 * @param array $data
		 * @return string|Ambigous <string, boolean>
		 */
		function add_user($data){
			
			if(!valid_email($data['email']))
				return "invalid_email";
			
			if($this->check_exist('email',$data['email']))
				return 	"existing_email";
			
			if(!valid_password($data['password']))
				return "invalid_password";
			
			if(!valid_real_name($data['real_name']))
				return "invalid_real_name";
			
			if(!valid_bluetooth_mac($data['bluetooth_mac']))
				return "invalid_bluetooth_mac";
			
			$data['bluetooth_mac']=strtoupper($data['bluetooth_mac']);
			if($this->check_exist('bluetooth_mac',$data['bluetooth_mac']))
				return "existing_bluetooth_mac";
			
			$data['password'] = md5($data['password']);
			$data['display_name']=$data['real_name'];
			$num=$this->check_exist('real_name',$data['real_name']);
			$data['real_name']=$data['real_name'].'('.($num+1).')';
			$data['create_time']=time();
			
			$this->db->insert($this->user_table,$data);
			return ($this->db->affected_rows() > 0) ? "success_".$this->db->insert_id() : FALSE;
		}
		

		
		/**
		 * 验证用户账号和密码
		 * @param string $username 账号
		 * @param string $password 密码
		 * @return Ambigous <boolean, unknown>
		 */
		function validate_user($data)
		{
			$userdata = FALSE;
			
			$this->db->where('email', $data['email']);
			$query = $this->db->get($this->user_table);
			
			if($query->num_rows() == 1)
	        {
	            $userdata = $query->row_array();
	        }
	      		
			if(!empty($userdata))
			{
				$userdata = ($userdata['password']===md5($data['password'])) ? $userdata : FALSE;
			}
			
			$query->free_result();
			
			return $userdata;
		}
		
		/**
		 * 验证某个内容是否存在
		 * @param string $key
		 * @param string $value
		 * @param int $exclude_uid
		 * @return boolean
		 */
		function check_exist($key = 'email',$value = '', $exclude_uid = 0)
		{
			if(!empty($value))
			{
				if($key=='real_name'){
					$this->db->select('user_id')->from($this->user_table)->like($key,$value.'(','after');
				}else {
					$this->db->select('user_id')->from($this->user_table)->like($key,$value);
				}
				
				
				if(!empty($exclude_uid) && is_numeric($exclude_uid))
				{
					$this->db->where('uid <>', $exclude_uid);
				}
		
				$query = $this->db->get();
				$num = $query->num_rows();
				$query->free_result();
		
				return $num;
			}
			return FALSE;
		}

	}
	

		
		